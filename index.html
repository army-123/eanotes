<!DOCTYPE html>
<html>
<head>
  <title>EA Notes Cloud</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    label { display: block; margin-top: 15px; }
    button { margin-top: 10px; padding: 10px 20px; }
    #status { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

<h2>EA Notes Cloud</h2>

<label>Email</label>
<input id="email" type="text" placeholder="teacher@example.com">

<label>Password</label>
<input id="password" type="password">

<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>

<hr>

<h3>Upload PDF</h3>

<label>Select Subject</label>
<select id="subject">
  <option>Anatomy</option>
  <option>Physiology</option>
  <option>Pathology</option>
  <option>Biochemistry</option>
  <option>Pharmacology</option>
</select>

<br><br>
<input id="fileInput" type="file" accept="application/pdf">

<button onclick="uploadFile()">Upload PDF</button>

<p id="status">Waiting...</p>

<hr>

<h3>Files</h3>
<button onclick="loadFiles()">Refresh</button>

<div id="fileList"></div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const supabase = createClient(
  "https://hlstgluwamsuuqlctdzk.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhsc3RnbHV3YW1zdXVxbGN0ZHprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzMwMzQsImV4cCI6MjA3OTg0OTAzNH0.KUPx3pzrcd3H5aEx2B7mFosWNUVOEzXDD5gL-TmyawQ"
);

async function login() {
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;

  const { error } = await supabase.auth.signInWithPassword({ email, password });

  if (error) alert("Login failed: " + error.message);
  else alert("Login success!");

  loadFiles();
}

async function logout() {
  await supabase.auth.signOut();
  alert("Logged out");
}

async function uploadFile() {
  const file = document.getElementById("fileInput").files[0];
  const subject = document.getElementById("subject").value;

  if (!file) {
    alert("Select a PDF first!");
    return;
  }

  document.getElementById("status").innerHTML = "Uploading...";

  const fileName = `${Date.now()}-${file.name}`;

  // upload to bucket
  let { data, error } = await supabase
    .storage
    .from("files")
    .upload(fileName, file);

  if (error) {
    alert("Upload error: " + error.message);
    return;
  }

  // get public URL
  const { data: urlData } = supabase
    .storage
    .from("files")
    .getPublicUrl(fileName);

  // insert DB record
  await supabase.from("files").insert({
    name: file.name,
    subject: subject,
    url: urlData.publicUrl
  });

  document.getElementById("status").innerHTML = "Uploaded!";
  loadFiles();
}

async function loadFiles() {
  const { data, error } = await supabase.from("files").select("*").order("created_at", { ascending: false });

  if (error) {
    alert("Error loading files: " + error.message);
    return;
  }

  let html = "";
  data.forEach(f => {
    html += `
      <p>
        <b>${f.subject}</b> â€” ${f.name}
        <a href="${f.url}" target="_blank">Open</a>
      </p>
    `;
  });

  document.getElementById("fileList").innerHTML = html;
}
</script>

</body>
</html>
