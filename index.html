<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EA Notes â€” Cloud Version (Perfect)</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f4f7fb;
      --card: #ffffff;
      --muted: #7b8794;
      --accent: #0b69ff;
      --danger: #e23b3b;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:linear-gradient(180deg,#e6eefc,#f7fbff);
      font-family:Inter,system-ui;
      display:flex;align-items:center;justify-content:center;padding:24px;
    }

    .app{
      width:390px;max-width:95%;background:white;border-radius:20px;
      box-shadow:0 20px 50px rgba(0,0,0,0.12);overflow:hidden;
    }
    header{padding:16px 20px;display:flex;align-items:center;justify-content:space-between;background:#fff;border-bottom:1px solid #eee}
    .logo{background:#0b69ff;color:white;font-weight:700;width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:18px}
    main{padding:20px}
    .card{background:var(--card);padding:16px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,0.05);margin-bottom:14px}
    input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;font-size:14px}
    .btn{padding:10px 14px;border-radius:10px;border:none;font-weight:600;cursor:pointer;width:100%;}
    .btn.primary{background:var(--accent);color:white}
    .btn.ghost{background:white;border:1px solid #0b69ff;color:#0b69ff}
    .btn.danger{background:var(--danger);color:white}
    .file-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border:1px solid #eee;border-radius:10px;margin-top:8px}
    .actions{display:flex;gap:8px}
    .view-btn{background:#0b69ff;color:white;border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer}
  </style>
</head>
<body>
<div class="app">
  <header>
    <div style="display:flex;gap:10px;align-items:center">
      <div class="logo">EA</div>
      <div>
        <div style="font-weight:700">EA Notes (Cloud)</div>
        <div style="font-size:11px;color:var(--muted)">For teachers & students</div>
      </div>
    </div>
    <div id="userRole" style="font-size:13px;color:var(--muted)">Not logged in</div>
  </header>

  <main>
    <!-- LOGIN CARD -->
    <div id="loginCard" class="card">
      <label>Username</label>
      <input id="username" type="text" placeholder="Your name" />

      <label style="margin-top:10px">Password</label>
      <input id="password" type="password" placeholder="Enter password" />

      <div style="display:flex;gap:10px;margin-top:14px">
        <button class="btn primary" onclick="appLogin()">Login</button>
        <button class="btn ghost" onclick="toggleDark()">ðŸŒ™</button>
      </div>
    </div>

    <!-- APP CARD -->
    <div id="appCard" class="card" style="display:none">
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:12px">
        <select id="folderSelect" onchange="loadFiles()">
          <option>Anatomy</option>
          <option>History</option>
          <option>Inclusiveness</option>
          <option>Civics</option>
          <option>Global affairs</option>
          <option>Geography</option>
          <option>Psychology</option>
        </select>

        <!-- CLEAN UPLOAD BUTTON -->
        <div id="uploadSection" style="display:none;">
          <label for="fileUpload" class="btn ghost" style="padding:8px 14px;cursor:pointer;">ðŸ“¤ Upload</label>
          <input id="fileUpload" type="file" style="display:none" />
        </div>
      </div>

      <div id="fileList"></div>

      <div style="display:flex;gap:10px;margin-top:14px">
        <button class="btn danger" onclick="appLogout()">Logout</button>
        <button class="btn ghost" onclick="toggleDark()">Theme</button>
      </div>
    </div>
  </main>
</div>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

<script>
// ðŸ”¥ INSERT YOUR FIREBASE CONFIG HERE
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "",
  appId: ""
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

const TEACHER_PASS = "@teacher123";
const STUDENT_PASS = "@armyamanu";

let currentUser = null;
let currentRole = null;

function appLogin(){
  const name = username.value.trim();
  const pass = password.value.trim();

  // Require name for students
  if(pass === STUDENT_PASS && name === ""){
    alert("Students must enter a name.");
    return;
  }

  if(pass === TEACHER_PASS) currentRole = "teacher";
  else if(pass === STUDENT_PASS) currentRole = "student";
  else return alert("Incorrect password");

  showLoader();

  auth.signInAnonymously().then(res=>{
    currentUser = res.user;
    return db.collection("users").doc(res.user.uid).set({name,role:currentRole},{merge:true});
  }).then(()=>{
    hideLoader();

    loginCard.style.display="none";
    appCard.style.display="block";
    userRole.textContent=currentRole;
    uploadSection.style.display = (currentRole==="teacher") ? "block" : "none";

    loadFiles();
  }).catch(err=>{
    hideLoader();
    alert("Login failed: " + err.message);
  });
}
  });
}

function appLogout(){ location.reload(); }

fileUpload.onchange = (e)=>{
  if(currentRole!=="teacher") return alert("Only teachers can upload.");

  const file = e.target.files[0];
  if(!file) return;

  const subject = folderSelect.value;
  const ref = storage.ref().child(`files/${subject}/${Date.now()}_${file.name}`);
  const uploadTask = ref.put(file);

  uploadTask.on('state_changed',()=>{},
    err=>alert("Upload failed"),
    async()=>{
      const url = await uploadTask.snapshot.ref.getDownloadURL();
      await db.collection("files").add({
        subject,
        name:file.name,
        size:file.size,
        url,
        time:Date.now()
      });
      loadFiles();
    }
  );
};

async function loadFiles(){
  const subject = folderSelect.value;
  const list = document.getElementById("fileList");
  list.innerHTML = "<div style='color:#777'>Loading...</div>";

  const snap = await db.collection("files").where("subject","==",subject).orderBy("time","desc").get();

  if(snap.empty){ list.innerHTML = "<div style='color:#777'>No files added.</div>"; return; }

  list.innerHTML = "";

  snap.forEach(doc=>{
    const f = doc.data();
    list.innerHTML += `
      <div class='file-row'>
        <div>
          <div style='font-weight:600'>${f.name}</div>
          <div style='font-size:12px;color:#777'>${(f.size/1024).toFixed(1)} KB</div>
        </div>
        <div class='actions'>
          <button class='view-btn' onclick="window.open('${f.url}','_blank')">View</button>
          ${currentRole==="teacher" ? `<button class='btn ghost' onclick="deleteFile('${doc.id}','${f.url}')">Delete</button>` : ""}
        </div>
      </div>`;
  });
}

async function deleteFile(id,url){
  if(!confirm("Delete file?")) return;

  await db.collection("files").doc(id).delete();

  const path = decodeURIComponent(url.split('/o/')[1]).split('?')[0];
  await storage.ref().child(path).delete().catch(()=>{});

  loadFiles();
}

function toggleDark(){
  document.body.style.background = document.body.style.background.includes("0f17") ?
    "linear-gradient(180deg,#e6eefc,#f7fbff)" : "linear-gradient(180deg,#0f1724,#0b233f)";
}
</script>

<div id="loaderOverlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);backdrop-filter:blur(3px);z-index:999;align-items:center;justify-content:center;">
  <div style="width:60px;height:60px;border:6px solid #fff;border-top-color:#0b69ff;border-radius:50%;animation:spin 0.9s linear infinite"></div>
</div>

<style>
@keyframes spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
</style>

<script>
function showLoader(){ document.getElementById('loaderOverlay').style.display = 'flex'; }
function hideLoader(){ document.getElementById('loaderOverlay').style.display = 'none'; }
</script>

</body>
</html>
